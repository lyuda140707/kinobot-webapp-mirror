<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RelaxTime Web App</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="https://example.com/my-favicon.ico">
  <link rel="stylesheet" href="style.css?v=50" />
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>

    

    
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #111;
      color: #fff;
    }
    .section {
      display: none;
      padding: 20px;
    }
    .active {
      display: block;
    }
    .nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 6px;
      border-top: 1px solid #333;
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0, 255, 255, 0.15);
    }
    .nav button {
      background: none;
      border: none;
      color: #aaa;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 10px;
      transition: all 0.2s ease-in-out;
      position: relative;
    }
    .nav button span {
      margin-top: 4px;
      font-size: 14px;
    }
    .nav button.active {
      color: #00f7ff;
      text-shadow: 0 0 6px #00f7ff;
      transform: scale(1.1);
    }
    .nav button.active::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 50%;
      transform: translateX(-50%);
      width: 36%;
      height: 3px;
      border-radius: 3px;
      background: #00f7ff;
      box-shadow: 0 0 8px #00f7ff;
    }
    
    .back-button {
      background: #444;
      color: #fff;
      padding: 8px 16px;
      margin-bottom: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
.loader {
  border: 4px solid #444;
  border-top: 4px solid #fff;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  display: inline-block;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


    .skeleton {
  background-color: #333;
  border-radius: 8px;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
    /* Для анімації появи модалки */
#confirm-modal {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#confirm-modal.show {
  opacity: 1;
  pointer-events: auto;
}
@keyframes pulse-glow {
  0% {
    text-shadow: 0 0 6px #00f7ff;
    transform: scale(1);
  }
  50% {
    text-shadow: 0 0 15px #00f7ff;
    transform: scale(1.15);
  }
  100% {
    text-shadow: 0 0 6px #00f7ff;
    transform: scale(1);
  }
}

/* === НОВИЙ СТИЛЬ ДЛЯ DONATE-POPUP === */
#donate-popup {
  display: none; /* цю властивість JS керує */
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ff7f50, #ff4500);
  border: 2px solid #fff;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  box-shadow:
    0 0 12px rgba(255,69,0,0.8),
    0 0 24px rgba(255,140,0,0.6);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  z-index: 9999;
}

#donate-popup:hover {
  transform: translateX(-50%) translateY(-4px);
  box-shadow:
    0 0 16px rgba(255,69,0,1),
    0 0 32px rgba(255,140,0,0.8);
}

/* кнопка «Підтримати» */
#donate-popup .btn-donate {
  display: inline-block;
  background-color: #ffd700;
  color: #000;
  padding: 12px 24px;
  font-weight: bold;
  text-decoration: none;
  border-radius: 8px;
  text-shadow: 0 0 6px rgba(255,215,0,0.8);
  box-shadow: 0 0 10px rgba(255,215,0,0.6);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#donate-popup .btn-donate:hover {
  transform: scale(1.05);
  box-shadow:
    0 0 14px rgba(255,215,0,1),
    0 0 28px rgba(255,215,0,0.8);
}

/* хрестик закриття */
#donate-popup > button {
  position: absolute;
  top: 6px;
  right: 10px;
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #fff;
  transition: transform 0.2s ease;
}

#donate-popup > button:hover {
  transform: scale(1.2);
}


.series-episodes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.series-episodes-grid .search-button {
  font-size: 11.5px;
  padding: 6px 10px;
  border-radius: 10px;
  white-space: normal;
  line-height: 1.1;
  text-align: center;
}


.series-poster {
  width: 100px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
  margin-right: 10px;
  vertical-align: middle;
}
    
/* для всіх контейнерів з результатами фільмів */
#genre-results,
#searchResults,
#fav-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;        /* відстань між картками */
  padding: 10px;    /* при потребі ваші відступи */
}



.film-card {
  background: #1a1a1a;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 0 10px cyan;
  box-sizing: border-box;
  width: 100%;
  max-width: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
}





.film-img {
  width: 100%;
  max-width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 10px;
}




.film-content {
  text-align: center;
}

.search-button {
  background-color: #00d4ff;
  color: #000;
  border: none;
  border-radius: 20px;
  padding: 6px 14px;
  font-weight: bold;
  margin: 4px;
  cursor: pointer;
}

.favorite-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
}
.film-rating {
  font-weight: bold;
  color: #00ffff;
  font-size: 14px;
  margin: 6px 0;
  text-shadow: 0 0 5px rgba(0,255,255,0.3);
  background: rgba(0,255,255,0.1);
  padding: 4px 8px;
  border-radius: 8px;
  display: inline-block;
}

.film-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 10px;
  flex-wrap: wrap;
}    

.film-actions {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
  flex-wrap: wrap;
}



/* НЕОНОВИЙ СВІТЛЯНИЙ ЕФЕКТ ДЛЯ IMDb */
.film-card .film-imdb {
  font-size: 12px;
  font-weight: bold;
  color: #00ffff;
  margin: 4px 0;
  text-shadow:
    0 0 4px rgba(0,255,255,0.6),
    0 0 8px rgba(0,255,255,0.4),
    0 0 12px rgba(0,255,255,0.2);
}

/* Ключові кадри для пульсації */
@keyframes glow {
  from {
    text-shadow:
      0 0 2px rgba(0,255,255,0.5),
      0 0 6px rgba(0,255,255,0.3);
  }
  to {
    text-shadow:
      0 0 8px rgba(0,255,255,1),
      0 0 16px rgba(0,255,255,0.8);
  }
}

/* Клас для додавання анімації */
.film-card .film-imdb.pulsate {
  animation: glow 1.5s ease-in-out infinite alternate;
}


/* маленький шрифт для лічильників лайків/дизлайків */
.film-rating span {
  font-size: 12px;
  vertical-align: middle;
}

#genre-results {
  display: none;      /* приховуємо за замовчуванням */
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  padding: 10px;
}

/* Центруємо кнопки в контейнері #genres */
/* === Головна: кнопки Фільми/Серіали/Мультфільми === */
#genres {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  margin: 24px auto;
}

/* базовий стан */
#genres .genre-btn {
  background-color: #222;
  border: 1px solid #444;
  padding: 8px 16px;                 /* зменшили відступи */
  border-radius: 20px;               /* трохи менші закруглення */
  font-size: 16px;                   /* зменшили розмір шрифту */
  font-weight: 500;
  color: #00f7ff;
  text-shadow: 0 0 5px #00f7ff;      /* легший ореол */
  display: flex;
  align-items: center;
  gap: 6px;                          /* зменшили відстань між іконкою і текстом */
  box-shadow:
    0 0 6px  #00f7ff,
    0 0 12px rgba(0,255,255,0.4),
    0 0 18px rgba(0,255,255,0.2);
  transition: all 0.2s ease-in-out;
}

/* підсвітка при наведенні і у “активного” стану */
#genres .genre-btn:hover {
  color: #ccc;
  text-shadow: none;
  box-shadow: none;
}


  </style>
 
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  
    <!-- Після <script src="https://telegram.org/js/telegram-web-app.js"></script> -->
  <script>
    // 1) Перевіряємо, що працюємо всередині Telegram WebApp
    if (!window.Telegram || !window.Telegram.WebApp) {
      document.body.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;color:#fff;background:#111;">
          <h2>Цей додаток запускається лише в Telegram</h2>
        </div>`;
      throw new Error('Не веб-App Telegram');
    }
    const tg = window.Telegram.WebApp;
    tg.ready();

    // 2) Перевіряємо, що отримали валідні дані користувача
    const user = tg.initDataUnsafe?.user;
    if (!user || typeof user.id !== 'number' || user.id === 0) {
      document.body.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;color:#00f7ff;background:#111;padding:1em;text-align:center;">
          <h2>⛔️ Не вдалося авторизуватися в Telegram</h2>
          <p>Можливо, проблеми з інтернетом. Будь ласка, оновіть застосунок.</p>
          <button onclick="location.reload()" 
                  style="margin-top:20px;padding:12px 24px;border:none;border-radius:8px;background:#00f7ff;color:#000;font-weight:bold;cursor:pointer;">
            🔄 Спробувати знову
          </button>
        </div>`;
      throw new Error('Немає user.id');
    }
    // якщо всі перевірки пройшли — далі ваш існуючий код...
  </script>
<script>
// ⬇️ Додаємо ці дві функції (встав СЮДИ!)
function maskWord(word) {
  // Маскує: вставляє zero-width space між літерами
  return word.split('').join('\u200B');
}
function unmaskWord(word) {
  // Знімає маскування (прибирає zero-width space)
  return word.replace(/\u200B/g, '');
}
</script>

</head>
<body>
  <div id="home" class="section active">
    <h2>🎯 Топ за сьогодні</h2>
   <div id="film-of-the-day" class="film-day-card">
  <div class="image-wrapper" style="position: relative;">
    <img id="film-day-img" src="" alt="Топ за сьогодні">
    <div class="film-title-overlay" id="film-title">Назва фільму</div>
  </div>
  <div class="btn-container">
    <button id="openVideoById" class="watch-btn">👀 Поглянути</button>
  </div>
</div>



      <div id="home-loading" style="text-align:center; margin-top:30px;">
    <span class="loader"></span>
    <div style="margin-top:8px;">Завантаження...</div>
  </div>

    
    <h3>Розділи</h3>
    <div id="genres" style="display:none; flex-wrap:wrap; gap:10px;"></div>
    

    <h3 style="margin-top:25px">Добірки</h3>
  <div id="collections" style="
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 16px;
  padding: 10px 0;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
"></div>

    </div>
  

  <div id="categories" class="section">
<h2>Категорії</h2>
<button class="back-button" onclick="switchTab('home', document.querySelector('[data-tab=home]'))">
  ⬅️ Назад
</button>

<div class="genre-main-wrapper" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
  <button class="genre-main-btn" onclick="openGenreGroup('films')">
    🎯 Фільми за жанром
  </button>
  <button
    class="genre-main-btn"
    onclick="
      switchTab('categories', document.querySelector('[data-tab=categories]'));
      openGenreGroup('series');
      showSeries('Серіал');
    "
  >
    📺 Серіали
  </button>
  <button class="genre-main-btn" onclick="openGenreGroup('cartoons')">
    👧 Мультики
  </button>
</div>




  

   <!-- 🔽 Підкатегорії: За жанром -->
<div id="group-films" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Екшн(бойовики)">🔫 Екшн</button>
  <button class="genre-btn" data-genre="Комедії">😂 Комедії</button>
  <button class="genre-btn" data-genre="Детектив">🕵️ Детектив</button>
  <button class="genre-btn" data-genre="Драми">🎭 Драми</button>
  <button class="genre-btn" data-genre="Військові">🪖 Військові</button>
  <button class="genre-btn" data-genre="Фантастика">👽 Фантастика</button>
  <button class="genre-btn" data-genre="Документальний">📚 Документальний</button>
  <button class="genre-btn" data-genre="Трилери">😱 Трилери</button>
  <button class="genre-btn" data-genre="Сімейні">👨‍👩‍👧 Сімейні</button>
  <button class="genre-btn" data-genre="Мелодрами">💔 Мелодрами</button>
  <button class="genre-btn" data-genre="Кримінал">🚔 Кримінал</button>
  <button class="genre-btn" data-genre="Фентезі">🧝 Фентезі</button>
  <button class="genre-btn" data-genre="Пригоди">🌍 Пригоди</button>
  <button class="genre-btn" data-genre="Історичні">🏰 Історичні</button>
  <button class="genre-btn" data-genre="Романтичні">💘 Романтичні</button>
  <button class="genre-btn" data-genre="Жахи">👻 Жахи</button>
</div>

<!-- 🔽 Підкатегорії: Серіали -->
<div id="group-series" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Українські">🇺🇦 Українські</button>
  <button class="genre-btn" data-genre="Детективні">🕵️‍♀️ Детективні</button>
  <button class="genre-btn" data-genre="Драматичні">🎭 Драматичні</button>
  <button class="genre-btn" data-genre="Пригодницькі">🌄 Пригодницькі</button>
  <button class="genre-btn" data-genre="Комедійні">😂 Комедійні</button>
  <button class="genre-btn" data-genre="Мелодраматичні ">💔 Мелодраматичні </button>
  <button class="genre-btn" data-genre="Історичні серіали">🏰 Історичні серіали</button>
  <button class="genre-btn" data-genre="Фантастичні">👽 Фантастичні</button>
  <button class="genre-btn" data-genre="Кримінальні">🚔 Кримінальні</button>
</div>

<!-- 🔽 Підкатегорії: Мультики -->
<div id="group-cartoons" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Мультфільми">🎬 Мультфільми</button>
  <button class="genre-btn" data-genre="Мультсеріали">📺 Мультсеріали</button>
</div>

   <!-- 🔍 Фільтр за країною та роком -->
<details id="filter-details" style="margin-top: 20px; margin-bottom: 20px; background: #1c1c1c; border-radius: 10px; padding: 10px 15px;">
  <summary style="font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: #00f7ff;">🔎 Фільтри</summary>
  <div style="padding-top: 10px;">
    <h4 style="margin: 10px 0 5px; color: #ccc;">🌍 Країна</h4>
    <div id="country-filters" style="
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      max-height: 100px;
      overflow-y: auto;
    "></div>

    <h4 style="margin: 10px 0 5px; color: #ccc;">📅 Рік</h4>
    <div id="year-filters" style="
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-height: 100px;
      overflow-y: auto;
    "></div>
  </div>
</details>
    <div id="genre-results"></div>
    <div id="list-end-sentinel"></div>

  </div>

</div>


  <div id="favorites" class="section">
  <h2>Улюблене</h2>
  <button class="back-button" onclick="switchTab('account', document.querySelector('[data-tab=account]'))">⬅️ Назад</button>
  <div id="fav-list" class="film-list" style="display: none;"></div>
</div>


  <div id="search" class="section">
    <h2>Пошук</h2>
    <button class="back-button" onclick="switchTab('home', document.querySelector('[data-tab=home]'))">⬅️ Назад</button>
    <input type="text" id="searchInput" placeholder="Введіть назву або жанр..." style="width:100%;padding:10px;">
    <div id="searchResults" style="margin-top: 20px;"></div>
  </div>
<!-- ✅ Секція Акаунт -->
<section id="account" class="section">
  <h2>👤 Акаунт</h2>

  <hr style="margin: 20px 0; border-color: #444;">
  <h3>🔒 PRO Доступ</h3>
  <p style="font-size:14px; color:#ccc;">Відкриває доступ до всіх відео</p>
  <button id="getProBtn" class="account-button" style="background:#00f7ff; color:#000; font-weight:bold;">🚀 Отримати PRO</button>
  <p style="font-size:11px; color:#aaa; margin-top:5px;">Будь-яка сума — PRO доступ</p>


  <button id="confirmPaidBtn" class="account-button" style="background:#00f7ff; color:#000; font-weight:bold; display:none;">
    ✅ Я оплатив
  </button>


  <!-- Додай цю кнопку у профіль (аккаунт) -->
  <div id="contact-admin-section" style="margin: 18px 0;">
    <button id="contact-admin-btn" class="account-button" style="background:#00f7ff; color:#000; font-weight:bold;">
      ✉️ Написати адміну
    </button>
  </div>

  <!-- Модальне вікно для введення повідомлення адміну -->
  <div id="admin-message-modal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6)">
    <div style="background:#222; color:#fff; border-radius:18px; padding:24px; width:96vw; max-width:420px; margin:10vh auto; display:flex; flex-direction:column;">
      <textarea id="admin-message-text" rows="5" placeholder="Ваше повідомлення адміністратору" style="resize:none; padding:12px; border-radius:10px; font-size:15px;"></textarea>
      <button id="send-admin-message-btn" style="margin-top:13px; background:#0ac075; color:#fff; border:none; border-radius:10px; padding:9px 0; font-weight:600; font-size:17px;">Відправити</button>
      <button id="close-admin-modal-btn" style="margin-top:8px; background:#d52a43; color:#fff; border:none; border-radius:10px; padding:9px 0; font-size:15px;">Скасувати</button>
   </div>
  </div>
 
 <!-- 🚀 Launcher: перехід до лаунчер-бота -->
<div id="launcher-section" style="margin: 12px 0;">
  <button id="launcher-btn"
          class="account-button"
          style="background:#00f7ff; color:#000; font-weight:bold;">
    🚀 Отримувати оновлення через Launcher
  </button>
</div>



<hr style="margin: 20px 0; border-color: #444;">



<div style="margin: 20px 0;">
  <label for="theme-toggle" style="font-weight: bold;">🌙 Темна тема</label>
  <input type="checkbox" id="theme-toggle" />
</div>


  <!-- Підтримка проекту -->
  <h3>🤝 Підтримати проєкт</h3>
  <div style="margin: 12px 0; text-align: center;">
    <a href="https://send.monobank.ua/jar/9wTjSL3xu2"
       target="_blank"
       class="btn-donate"
       style="margin-right:8px;">
      ☕ На каву адміну
    </a>
  </div>

 

</section>

  <div class="nav">
    <button class="nav-btn" data-tab="account">👤<span>Акаунт</span></button>
    <button class="nav-btn active" data-tab="home">🏠<span>Головна</span></button>
    <button class="nav-btn" data-tab="categories">🎞️<span>Категорії</span></button>
    <button class="nav-btn" data-tab="favorites">💛<span>Улюблене</span></button>
    <button class="nav-btn" data-tab="search">🔍<span>Пошук</span></button>
  </div>

  <div id="loading-indicator" style="display: none;">
  <div class="loader"></div>
  <div>Завантаження фільму...</div>
    
</div>
<div id="payment-loading" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.55);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">
  <div style="text-align:center;">
    <div class="loader"></div>
    <div style="margin-top: 12px; color: #00f7ff;">
      Перевіряємо оплату...<br>
      <span style="font-size:13px;color:#aaa;">Якщо не спрацює — зачекайте 10-15 сек і повторіть ще раз.</span>
    </div>
  </div>
</div>


  <script>

    const placeholderImage = "https://i.postimg.cc/6q9Cd9sQ/d9d66124-1900-49be-a89c-007edc35bd13.png";
    
    let films = [];
    let isDataLoaded = false;
    let proPollInterval = null;

    const BATCH_SIZE = 50;
    let currentFilms = [];
    let offset = 0;

function renderBatch() {
  const container = document.getElementById('genre-results');
  container.style.display = 'grid';
  const isPro = localStorage.getItem('isProUser') === 'true';
  const batch = currentFilms.slice(offset, offset + BATCH_SIZE);

  const html = batch.map(film => {
    const isProFilm = film['Доступ'] === 'PRO';
    const imgSrc    = (isProFilm && !isPro)
                      ? placeholderImage
                      : (film['Фото'] || placeholderImage);
    const id        = safeId(film['Назва']);

   let btn = '';
   if (isProFilm && !isPro) {
     btn = `<button class="search-button" onclick="showProModal()">🔒 PRO Доступ</button>`;
    } else if (film['message_id']) {
     btn = `<button class="search-button" onclick="requestFilmByName('${film['message_id']}')">▶️ Дивитись</button>`;
    }

    return `
      <div class="film-card" id="film-${id}">
        <img src="${imgSrc}" alt="${film['Назва']}" class="film-img">
        <h3>${maskWord(film['Назва'])}</h3>
        <p class="film-imdb">IMDb: ${film['IMDb'] || '—'}</p>
        <p>${film['Опис'] || ''}</p>
        <div class="film-actions">
          ${renderControls(film['Назва'], film['Опис'])}
          ${btn}
        </div>
      </div>
    `;
  }).join('');

  container.insertAdjacentHTML('beforeend', html);
  offset += batch.length;
}



async function loadFilms() {
  const cached = localStorage.getItem('films');
  const ts = localStorage.getItem('filmsTimestamp');
  const maxAge = 1000 * 60 * 60 * 48; // 48 годин

  if (cached && ts && (Date.now() - Number(ts) < maxAge)) {
    films = JSON.parse(cached);
    shuffleArray(films);
    console.log('✅ Фільми з кешу');

    // Оновлюємо UI
    showFilmOfTheDay();
    showCollections();
    showGenres();
    showCountryFilters();
    showYearFilters();

    isDataLoaded = true;

    // Перший батч карток + оновлення їх рейтингів
    currentFilms = films;
    offset = 0;
    renderBatch();
   


    return;
  }

  // Якщо в кеші немає — підтягуємо з мережі
  await fetchAndUpdateFilms();
  isDataLoaded = true;

  // Перший батч карток + оновлення їх рейтингів
  currentFilms = films;
  offset = 0;
  renderBatch();
  
}



async function fetchAndUpdateFilms() {
  try {
    document.getElementById('home-loading').style.display = 'block';

    const res = await fetch(
      `https://opensheet.vercel.app/1LlkMITwr1sXyQI_jmfhrhEPXB2L22MCh8GIXNm5aoTQ/Sheet1?cb=${Date.now()}`
    );
    const loadedFilms = await res.json();

    if (!loadedFilms || loadedFilms.length === 0) {
      throw new Error('Отримано пустий список фільмів');
    }

    films = loadedFilms;
    shuffleArray(films);

    localStorage.setItem('films', JSON.stringify(films));
    localStorage.setItem('filmsTimestamp', Date.now().toString());

    showFilmOfTheDay();
    showCollections();
    showGenres();
    showCountryFilters();
    showYearFilters();
  } catch (error) {
    console.error('Помилка завантаження фільмів:', error);

    const cached = localStorage.getItem('films');
    if (!cached || JSON.parse(cached).length === 0) {
      showServiceErrorModal("⚠️ Виникла проблема з підключенням. Спробуй перезапустити застосунок.");
      localStorage.removeItem('films');
      localStorage.removeItem('filmsTimestamp');
    }
  } finally {
    document.getElementById('home-loading').style.display = 'none';
  }
}





let pendingLink = "";

async function openVideoById(filmName) {
  const tg = window.Telegram.WebApp;
  if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
    alert("⛔️ Не вдалося отримати ваш Telegram ID. Оновіть застосунок!");
    window.location.reload();
    return;
  }

 

  const user = tg.initDataUnsafe.user;

  // 🔒 Перевірка доступу PRO
  const isPro = localStorage.getItem('isProUser') === 'true';
  const film = films.find(f => f['Назва'] === filmName);

  if (film?.['Доступ'] === 'PRO' && !isPro) {
    showProPrompt();
    return;
  }

  document.getElementById("loading-indicator").style.display = "block";

  // ⛔ Заблокуємо всі кнопки "Дивитись" на 3 секунди
  document.querySelectorAll('.search-button').forEach(btn => btn.disabled = true);
  setTimeout(() => {
    document.querySelectorAll('.search-button').forEach(btn => btn.disabled = false);
  }, 3000);

  // ⏳ Затримка 2 секунди перед запитом
  setTimeout(async () => {
    try {
      const response = await fetch('https://relax-time2.onrender.com/send-film', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: user.id,
          film_name: filmName
        })
      });

      const data = await response.json();
      console.log("🎬 Відповідь сервера:", data);

      if (data.success) {
        showRedirectButton();
      } else {
        showServiceErrorModal(`❗️ ${data.error || 'Невідома помилка'}`);
      }
    } catch (error) {
      console.error('❗️ Помилка при запиті:', error);
      showServiceErrorModal();
    } finally {
      document.getElementById("loading-indicator").style.display = "none";
    }
  }, 2000);
}

async function requestFilmByName(fileId) {
  const tg = window.Telegram.WebApp;
  if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
    alert("⛔️ Не вдалося отримати ваш Telegram ID. Оновіть застосунок!");
    window.location.reload();
    return;
  }
  const user = tg.initDataUnsafe.user;

  // Показуємо індикатор завантаження
  document.getElementById("loading-indicator").style.display = "block";

  // Додаємо невелику затримку перед запитом
  setTimeout(async () => {
    try {
      const response = await fetch(
        'https://relax-time2.onrender.com/send-film-id',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: user.id,
             message_id: fileId
          })
        }
      );

      const data = await response.json();
      if (data.success) {
        showRedirectButton();
      } else {
        showServiceErrorModal(`❗️ ${data.error || 'Невідома помилка'}`);
      }
    } catch (error) {
      console.error(error);
      alert("❗️ Сталася помилка при надсиланні фільму");
    } finally {
      // Ховаємо індикатор завантаження
      document.getElementById("loading-indicator").style.display = "none";
    }
  }, 2000);
}

    

    
function showRedirectButton() {
  const videoWrapper = document.getElementById('video-wrapper');
  videoWrapper.innerHTML = ''; // очищаємо вікно перед показом нового контенту

  const message = document.createElement('div');
  message.textContent = "✅ Фільм надіслано успішно!";
  message.style.marginTop = "10px";
  message.style.color = "#00f7ff";
  message.style.fontSize = "18px";
  message.style.fontWeight = "bold";

  const buttonsWrapper = document.createElement('div');
  buttonsWrapper.style.display = 'flex';
  buttonsWrapper.style.gap = '15px';
  buttonsWrapper.style.marginTop = '20px';
  buttonsWrapper.style.justifyContent = 'center';
  buttonsWrapper.style.flexWrap = 'wrap';

  // Кнопка "Перейти до бота"
  const confirmButton = document.createElement('button');
  confirmButton.className = "watch-btn";
  confirmButton.textContent = "🎬 Перейти до контенту";
  confirmButton.style.padding = "10px 20px";
  confirmButton.style.borderRadius = "10px";
  confirmButton.style.background = "#00f7ff";
  confirmButton.style.color = "#000";
  confirmButton.style.fontWeight = "bold";
  confirmButton.style.cursor = "pointer";
  confirmButton.style.boxShadow = "0 0 10px #00f7ff";
  confirmButton.onclick = () => {
    window.Telegram.WebApp.close();
  };

  // Кнопка "Ні, залишитись тут"
  const cancelButton = document.createElement('button');
  cancelButton.className = "watch-btn";
  cancelButton.textContent = "❌ Залишитись тут";
  cancelButton.style.padding = "10px 20px";
  cancelButton.style.borderRadius = "10px";
  cancelButton.style.background = "#444";
  cancelButton.style.color = "#fff";
  cancelButton.style.fontWeight = "bold";
  cancelButton.style.cursor = "pointer";
  cancelButton.onclick = () => {
    const overlay = document.getElementById('video-overlay');
    overlay.style.opacity = '0';
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);
  };

  buttonsWrapper.appendChild(confirmButton);
  buttonsWrapper.appendChild(cancelButton);

  videoWrapper.appendChild(message);
  videoWrapper.appendChild(buttonsWrapper);

  const overlay = document.getElementById('video-overlay');
  overlay.style.display = 'flex';
  setTimeout(() => {
    overlay.style.opacity = '1';
  }, 50);
}



function confirmOpen() {
  const modal = document.getElementById('confirm-modal');
  modal.classList.remove('show');
  setTimeout(() => {
    try {
      if (window.Telegram?.WebApp?.openLink) {
        window.Telegram.WebApp.openLink(pendingLink);
      } else {
        window.open(pendingLink, '_blank');
      }
    } catch (e) {
      console.error('Помилка при відкритті лінку:', e);
      window.open(pendingLink, '_blank');
    } finally {
      pendingLink = "";
    }
  }, 200); // ← Ось ця кома і правильне закриття
}

function cancelOpen() {
  const modal = document.getElementById('confirm-modal');
  modal.classList.remove('show');
  pendingLink = "";
}





function closeVideo() {
  const videoOverlay = document.getElementById('video-overlay');
  const videoWrapper = document.getElementById('video-wrapper');

  videoWrapper.innerHTML = '';
  videoOverlay.style.opacity = '0';
  setTimeout(() => {
    videoOverlay.style.display = 'none';
  }, 400);
}






function showFilmOfTheDay() {
  document.getElementById('film-day-img').classList.remove('skeleton');
  document.getElementById('film-day-img').style.background = 'none';

  const film = films[Math.floor(Math.random() * films.length)];
  document.getElementById('film-day-img').src = film['Фото'];

  document.getElementById('openVideoById').onclick = () => {
    const videoUrl = film['message_id']; // ⬅️ тут тепер 'Посилання'
    openVideoById(film['Назва']); // ⬅️ відкриваємо
  };

  document.getElementById('film-title').textContent = maskWord(film['Назва']);

}


    function showSkeletonFilmOfTheDay() {
  document.getElementById('film-day-img').style.background = '#333';
  document.getElementById('film-day-img').classList.add('skeleton');
  document.getElementById('film-title').textContent = '';
}


function showAllFilms() {
  // перемикаємося у вкладку “Категорії”
  switchTab('categories', document.querySelector('[data-tab=categories]'));
  // показуємо підгрупу “Фільми за жанром”
  openGenreGroup('films');
}


function showGenres() {
  // тепер тільки Фільми, Серіали, Мультфільми
  const genres = ['Фільми', 'Серіали', 'Мультфільми'];
  document.getElementById('genres').innerHTML = genres.map(g => {
    if (g === 'Фільми') {
      return `<button class="genre-btn" onclick="showAllFilms()">🎞️ ${g}</button>`;
    }
    if (g === 'Серіали') {
      return `
        <button class="genre-btn"
                onclick="
                  switchTab('categories', document.querySelector('[data-tab=categories]'));
                  openGenreGroup('series');
                  showSeries('Серіал');
                ">
          📺 ${g}
        </button>`;
    }
    // Мультфільми
    return `<button class="genre-btn" onclick="goToCartoons()">👧 ${g}</button>`;
  }).join('');
  document.getElementById('genres').style.display = 'flex';
}



    
    function showCountryFilters() {
  const countries = [...new Set(films.map(f => f['Країна']).filter(Boolean))];
  const container = document.getElementById('country-filters');
  container.innerHTML = countries.map(country => `
    <button class="genre-btn" onclick="filterByCountry('${country}')">${country}</button>
  `).join('');
  container.style.display = 'flex';
}

function showYearFilters() {
  const years = [...new Set(films.map(f => f['Рік']).filter(Boolean))];
  const container = document.getElementById('year-filters');
  container.innerHTML = years.map(year => `
    <button class="genre-btn" onclick="filterByYear('${year}')">${year}</button>
  `).join('');
  container.style.display = 'flex';
}

    

    function showCollections() {
  const container = document.getElementById('collections');
  const names = [...new Set(films.map(f => f['Добірка']).filter(Boolean))];
  container.innerHTML = names.map(name => {
    const img = films.find(f => f['Добірка'] === name)?.['Фото'] || '';
    return `
      <div class="collection-card" onclick="filterByGenre('${name}')">
        <img src="${img}" alt="${name}">
        <p>${name}</p>
      </div>
    `;
  }).join('');
  document.getElementById('collections').style.display = 'flex';
}

    
function showSeries(type = 'Серіал') {
  const container = document.getElementById('genre-results');
  container.innerHTML = '';

  // Фільтруємо епізоди потрібного типу
  const seriesFilms = films.filter(f =>
    (f['Тип'] || '').trim().toLowerCase() === type.trim().toLowerCase()
  );
  if (!seriesFilms.length) {
    container.innerHTML = '<p>Немає серіалів 😢</p>';
    return;
  }

  // Групуємо за назвою, унікальні по опису
  const grouped = seriesFilms.reduce((acc, ep) => {
    const title = ep['Назва'];
    if (!acc[title]) acc[title] = [];
    const uniqueKey = (ep['Опис'] || '').toLowerCase();
    if (!acc[title].some(e => (e['Опис'] || '').toLowerCase() === uniqueKey)) {
      acc[title].push(ep);
    }
    return acc;
  }, {});

  // Генеруємо картки
  const html = Object.entries(grouped).map(([title, episodes]) => {
    const safe = safeId(title);
    const isPro     = localStorage.getItem('isProUser') === 'true';
    const isProFilm = episodes[0]['Доступ'] === 'PRO';
    const poster    = (isProFilm && !isPro)
      ? placeholderImage
      : (episodes[0]['Фото'] || placeholderImage);
    const count     = episodes.length;
    const imdb      = episodes[0]['IMDb'] || '—';

    return `
      <div class="film-card" id="film-${safe}">
        <img src="${poster}" class="film-img" alt="${title}">
        <h3>${maskWord(title)}</h3>
        ${renderControls(title, episodes[0]['Опис'])}
        <p class="film-imdb">IMDb: ${imdb}</p>
        <button class="search-button"
                onclick="toggleEpisodes('${safe}', this)"
                data-count="${count}">
          📺 Показати серії (${count})
        </button>
        <div id="episodes-${safe}"
             class="series-episodes-grid"
             style="display:none;"
             data-count="${count}">
          ${episodes.map((ep, i) => {
            const label = ep['Опис'] || `Серія ${i+1}`;
            return ep.message_id
              ? `<button class="search-button" onclick="requestFilmByName('${ep.message_id}')">${label}</button>`
              : `<button class="search-button" onclick="openVideoById('${title}')">${label}</button>`;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = html;
  container.scrollIntoView({ behavior: 'smooth' });
}


function openSeries(id) {
  const block = document.getElementById(`series-${id}`);
  if (block) {
    block.style.display = (block.style.display === 'none') ? 'block' : 'none';
  }
}


  function safeId(str) {
    return str.replace(/[^\w\d]/g, '_');
  }

function renderControls(title, description) {
  const id = safeId(title);
  const film = films.find(f => f['Назва'] === title) || {};
  const prev = localStorage.getItem(`rating-${title}`);
  const likeClass    = prev === 'like'    ? 'active-like'    : '';
  const dislikeClass = prev === 'dislike' ? 'active-dislike' : '';
  return `
  <button class="fav-button" onclick="addToFavorites('${title}','${(description||'').replace(/'/g,"\\'")}', '${film.message_id || ''}')">💛</button>
`;

}

    
function filterByGenre(genre) {
  if (!genre) return;
  switchTab('categories');
  const normalized = genre.trim().toLowerCase();
  const container  = document.getElementById('genre-results');

  // 1) Відфільтрувати за жанром/добіркою
  let filtered = films.filter(f => {
    const type = (f['Тип'] || '').trim().toLowerCase();
    const g1   = (f['Жанр']    || '').trim().toLowerCase();
    const g2   = (f['Добірка'] || '').trim().toLowerCase();
    return (g1.includes(normalized) || g2.includes(normalized));
  });

  // 2) Якщо користувач натиснув підкатегорію серіалів — лишити тільки Серіали
  if (document.getElementById('group-series').style.display === 'flex') {
    filtered = filtered.filter(f =>
      (f['Тип'] || '').trim().toLowerCase() === 'серіал'
    );
  }

  // 3) Нічого не знайдено?
  if (!filtered.length) {
    container.innerHTML = '<p>Нічого не знайдено 😢</p>';
    container.scrollIntoView({ behavior: 'smooth' });
    return;
  }

  // 4) Якщо це серіали — зібрати всі епізоди під кожною назвою
  if (filtered[0]['Тип']?.trim().toLowerCase() === 'серіал') {
    const grouped = filtered.reduce((acc, ep) => {
      const title = ep['Назва'];
      if (!acc[title]) acc[title] = [];
      const key = (ep['Опис']||'').trim().toLowerCase();
      if (!acc[title].some(e => (e['Опис']||'').trim().toLowerCase() === key)) {
        acc[title].push(ep);
      }
      return acc;
    }, {});

    container.innerHTML = Object.entries(grouped).map(([title, eps]) => {
      const safe      = safeId(title);
      const isPro     = localStorage.getItem('isProUser') === 'true';
      const isProFilm = eps[0]['Доступ'] === 'PRO';
      const poster    = (isProFilm && !isPro)
                        ? placeholderImage
                        : (eps[0]['Фото'] || placeholderImage);
      const count     = eps.length;

      // Генеруємо HTML картки серіалу
      return `
        <div class="film-card" id="film-${safe}">
          <img src="${poster}" class="film-img" alt="${title}">
          <h3>${maskWord(title)}</h3>
          <p class="film-imdb">IMDb: ${eps[0]['IMDb'] || '—'}</p>
          ${renderControls(title, eps[0]['Опис'])}
          <button class="search-button"
                  onclick="toggleEpisodes('${safe}', this)"
                  data-count="${count}">
            📺 Показати серії (${count})
          </button>
          <div id="episodes-${safe}"
               class="series-episodes-grid"
               style="display:none;"
               data-count="${count}">
            ${eps.map((ep, i) => {
              const label = ep['Опис'] || `Серія ${i+1}`;
              if (ep.message_id) {
                return `<button class="search-button"
                                 onclick="requestFilmByName('${ep.message_id}')"
                        >${label}</button>`;
              } else {
                return `<button class="search-button"
                                 onclick="openVideoById('${title}')"
                        >${label}</button>`;
              }
            }).join('')}
          </div>
        </div>
      `;
    }).join('');
    container.scrollIntoView({ behavior: 'smooth' });
    return;
  }

  // 5) Інакше — відмалювати як список фільмів
  currentFilms = filtered;
  container.innerHTML = '';
  offset = 0;
  renderBatch();
  container.scrollIntoView({ behavior: 'smooth' });
}

    
function filterByCountry(country) {
  switchTab('categories');
  const container = document.getElementById('genre-results');
  container.style.display = 'grid';
  container.innerHTML = '';

  currentFilms = films.filter(f => f['Країна'] === country);
  if (!currentFilms.length) {
    container.innerHTML = '<p>Нічого не знайдено 😢</p>';
    return;
  }
  offset = 0;
  renderBatch();
  container.scrollIntoView({ behavior: 'smooth' });
}


  

function filterByYear(year) {
  switchTab('categories');
  const container = document.getElementById('genre-results');
  const isPro = localStorage.getItem('isProUser') === 'true';
  const filtered = films.filter(f => String(f['Рік']) === String(year));

  if (!filtered.length) {
    container.innerHTML = '<p>Нічого не знайдено 😢</p>';
    return;
  }

  container.innerHTML = filtered.map(film => {
    const id = safeId(film['Назва']);           // ← Оголошуємо id!
    const isProFilm = film['Доступ'] === 'PRO';
    const imgSrc = (isProFilm && !isPro)
      ? placeholderImage
      : (film['Фото'] || placeholderImage);

    let buttons = '';
    if (isProFilm && !isPro) {
      buttons = `<button class="search-button" onclick="alert('🔒 Фільм доступний лише для PRO')">🔒 PRO Доступ</button>`;
    } else if (film['message_id']) {
      buttons = `<button class="search-button" onclick="openVideoById('${film['message_id']}')">▶️ Дивитись</button>`;
    }

    return `
      <div class="film-card" id="film-${id}">
        <img src="${imgSrc}" alt="${film['Назва']}">
        <h3>${maskWord(film['Назва'])}</h3>
        <p class="film-imdb">IMDb: ${film['IMDb']||'—'}</p>
        <p>${film['Опис']||''}</p>
        <div class="film-actions">
          ${renderControls(film['Назва'], film['Опис'])}
          ${buttons}
        </div>
      </div>
    `;
  }).join('');

  container.scrollIntoView({ behavior: 'smooth' });
}




   function showFavorites() {
  document.querySelectorAll('.film-card').forEach(el => el.remove());

  const container = document.getElementById('fav-list');
  container.innerHTML = '';

  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');

  if (favs.length === 0) {
    container.innerHTML = '<p>Немає улюблених</p>';
  } else {
  container.innerHTML = favs.map(f => {
    // Пошук фільму в масиві films по unmaskWord
    const found = films.find(item =>
      unmaskWord(item['Назва']) === unmaskWord(f.title)
    );
    const msgId = found?.message_id || f.message_id;
    const watchBtn = msgId
      ? `<button class="search-button" onclick="event.stopPropagation(); requestFilmByName('${msgId}')">▶️ Дивитись</button>`
      : `<span style="color:#888; display:block; margin-top:8px;">Недоступно</span>`;
    return `
      <div class="film-card" id="film-${safeId(f.title)}">
      <h3>${maskWord(f.title)}</h3>
      <p>${f.description}</p>
      <button class="remove-fav-btn" onclick="removeFromFavorites(${favs.indexOf(f)})">🗑️ Видалити</button>
      ${watchBtn}
    </div>
  `;
  }).join('');



    
  }

  container.style.display = 'grid';
}

function showProModal() {
  const modal = document.getElementById('pro-modal');
  modal.style.display = 'flex';
  setTimeout(() => modal.style.opacity = '1', 50);
}

function closeProModal() {
  const modal = document.getElementById('pro-modal');
  modal.style.opacity = '0';
  setTimeout(() => modal.style.display = 'none', 300);
}

  
// ⬇️ Сюди вставляєш нову функцію
function removeFromFavorites(index) {
  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
  favs.splice(index, 1);
  localStorage.setItem('favorites', JSON.stringify(favs));
  showFavorites(); // оновити список
}



    function searchInBot(query) {
      // 🧹 Повне очищення залишків
document.getElementById('history-list').innerHTML = '';
document.getElementById('searchResults').innerHTML = '';
document.querySelectorAll('.film-card').forEach(card => card.remove());

  // ❗️Спочатку ховаємо всі секції (прибирає візуальний "перекіс")
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // ✅ Повертаємось на головну
  document.getElementById('home').classList.add('active');
  document.querySelector('[data-tab=home]')?.classList.add('active');

  const tg = window.Telegram.WebApp;
  if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
    alert("⛔️ Не вдалося отримати ваш Telegram ID. Оновіть застосунок!");
    window.location.reload();
    return;
  }
  const user = tg.initDataUnsafe.user;


  document.getElementById("loading-indicator").style.display = "block";

  // Очищаємо пошук
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '';

  fetch('https://relax-time2.onrender.com/search-in-bot', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: user.id, query })
  }).then(r => r.json()).then(d => {
    if (d.found && d.videoUrl) {
      const existing = JSON.parse(localStorage.getItem('history') || '[]');
      if (!existing.find(f => f.title === query)) {
        const film = films.find(f => f['Назва'] === query);
        if (film) {
          existing.unshift({ title: film['Назва'], description: film['Опис'] });
          if (existing.length > 20) existing.pop();
          localStorage.setItem('history', JSON.stringify(existing));
        }
      }
      window.location.href = d.videoUrl;
    } else {
      showServiceErrorModal("Фільм не знайдено 😢");
    }
  }).catch(console.error).finally(() => {
    document.getElementById("loading-indicator").style.display = "none";
  });
}


    
    function openGenreGroup(group) {
  // ❌ Приховати ВСІ підкатегорії
  document.getElementById("group-films").style.display = "none";
  document.getElementById("group-series").style.display = "none";
  document.getElementById("group-cartoons").style.display = "none";

  // ❌ Очистити вивід результатів пошуку фільмів
  const container = document.getElementById('genre-results');
  if (container) {
    container.innerHTML = '';
  }

  // ✅ Показати тільки потрібну групу
  const block = document.getElementById("group-" + group);
  if (block) block.style.display = "flex";
}


function switchTab(tabId, btn) {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  const containersToClear = ['genre-results', 'searchResults', 'fav-list'];
  containersToClear.forEach(id => {
    const el = document.getElementById(id);
    if (el && tabId !== 'categories') {
      el.innerHTML = '';
      // ⬅️ Ось тут важливо: сховаємо genre-results
      if (id === 'genre-results') {
        el.style.display = 'none';
      }
    }
  });

  const target = document.getElementById(tabId);
  if (target) target.classList.add('active');
  if (btn) btn.classList.add('active');

  if (tabId === 'favorites') {
    if (!isDataLoaded) {
      alert("⏳ Дані ще завантажуються. Спробуй трохи пізніше.");
      return;
    }
    showFavorites();
  }

  if (tabId === 'search') {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchInput').focus();
    currentFilms = [];
    offset = 0;
  } else if (tabId === 'categories') {
    document.getElementById('genre-results').innerHTML = '';
    document.getElementById('genre-results').style.display = 'grid';
    currentFilms = [];
    offset = 0;
  }

  if (tabId === 'account') {
    if (!isDataLoaded) {
      alert("⏳ Дані ще завантажуються. Спробуй трохи пізніше.");
      return;
    }
    closeDonatePopup();
    window.scrollTo({ top: 0, behavior: 'smooth' });

    checkProPendingStatus();
  }
}



function showSkeletonCollections() {
  const container = document.getElementById('collections');
  container.innerHTML = `
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
  `;
}


  document.addEventListener('DOMContentLoaded', async () => {
    // Перевірка зʼєднання з Telegram після завантаження сторінки
    if (!window.Telegram.WebApp.initDataUnsafe?.user) {
      document.body.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
        <h2 style="color:#00f7ff;">⛔ Втрата з'єднання з Telegram</h2>
        <p>Оновіть застосунок для продовження</p>
        <button style="padding:12px 30px;border-radius:12px;background:#00f7ff;color:#000;font-weight:bold;font-size:18px;margin-top:15px;" onclick="window.location.reload()">🔄 Оновити</button>
      </div>
    `;
    }
        
    // Прокидаємо бекенд Render, щоб не спав
  try {
    await fetch('https://relax-time2.onrender.com/ping');
    console.log('✅ Бекенд прокинувся');
  } catch (e) {
    console.warn('⚠️ Бекенд не прокинувся:', e);
  }

  fetch('https://relax-time2.onrender.com/ping').catch(console.warn);
  Telegram.WebApp.ready();
  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;

  if (!user) {
    alert("Не вдалося отримати ваш Telegram ID");
    return;
  }

  localStorage.removeItem('films');


  try {
    const res = await fetch('https://relax-time2.onrender.com/check-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id })
    });

 
    const data = await res.json();

   if (!data.subscribed) {
  document.body.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #00f7ff;
      text-align: center;
      padding: 20px;
      font-family: 'Russo One', sans-serif;
    ">
      <h1 style="font-size: 28px; margin-bottom: 20px;">❗ Щоб користуватись застосунком</h1>
      <h2 style="font-size: 22px; margin-bottom: 40px;">Підпишіться на канал 🎥</h2>

     <h2 style="font-size: 22px; margin-bottom: 40px;">Активуйте доступ до контенту 🎬</h2>

<div style="display: flex; flex-direction: column; gap: 15px;">
  <a href="https://t.me/KinoTochkaUA" target="_blank" style="
    background: #00f7ff;
    color: #000;
    padding: 15px 30px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    text-decoration: none;
    box-shadow: 0 0 15px #00f7ff;
  ">🎬 Доступ до контенту</a>

  <a href="https://t.me/KinoTochkaFilms" target="_blank" style="
    background: #00f7ff;
    color: #000;
    padding: 15px 30px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    text-decoration: none;
    box-shadow: 0 0 15px #00f7ff;
  ">🎬 Доступ до контенту</a>
</div>

      <p style="margin-top: 40px; font-size: 16px; color: #ccc;">Після підписки оновіть застосунок 📲</p>
    </div>
  `;
  return;
}

  // ✅ Тут вставляємо перевірку PRO
const proRes = await fetch('https://relax-time2.onrender.com/check-pro', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ user_id: user.id })
});
const proData = await proRes.json();

if (proData.isPro) {
  localStorage.setItem('isProUser', 'true');
  localStorage.removeItem('paymentPending'); // Тут!
} else {
  localStorage.removeItem('isProUser');
  // Показати кнопку "Я оплатив", якщо paymentPending == true
  if (localStorage.getItem('paymentPending') === 'true') {
    showConfirmPaidButton(user);
    startProPolling();
  }
}



try {
  const getProBtn = document.getElementById('getProBtn');
  if (proData?.isPro && proData.expire_date) {
    // якщо кнопка є – ховаємо
    if (getProBtn) {
      getProBtn.style.display = 'none';
      const proNotice = document.createElement('p');
      proNotice.textContent = `✅ Ваш PRO активний до ${proData.expire_date}`;
      proNotice.style.color = "#00f7ff";
      proNotice.style.marginTop = "15px";
      getProBtn.parentNode.insertBefore(proNotice, getProBtn.nextSibling);
    }
  }
} catch (err) {
  console.error('Помилка при виведенні PRO-сповіщення:', err);
}



  fetch('https://relax-time2.onrender.com/reactivate-user', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: user.id })
  }).catch(console.warn);

} catch (error) {
  console.error('Помилка перевірки підписки', error);
  showRetryOverlay();
  return;
}

  // 🟢 Якщо підписаний, тільки тоді все інше:
  

  // Очищення кешу раз на добу
  const lastClear = localStorage.getItem('lastClear');
  const now = Date.now();
  if (!lastClear || now - lastClear > 1000 * 60 * 60 * 24) {
    localStorage.removeItem('films');
    localStorage.setItem('lastClear', now);
  }

  // Показати скелетони
  showSkeletonCollections();
  showSkeletonFilmOfTheDay();

  // Завантажити фільми і факти
  await loadFilms();

  // --- Lazy load observer ---
const sentinel = document.getElementById('list-end-sentinel');
const observer = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting && offset < currentFilms.length) {
    renderBatch();
    
  }
}, {
  rootMargin: '200px'

});
observer.observe(sentinel);


  

    // Якщо через 6 секунд фільми не завантажились — попередження
  setTimeout(() => {
    if (!films.length) {
      alert("⚠️ Можливо, слабкий інтернет. Спробуй ще раз або перезапусти застосунок.");
    }
  }, 6000);

 

  // Показати фільтри країн і років
  showCountryFilters();
  showYearFilters();

  // Темна тема
  const toggle = document.getElementById('theme-toggle');
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    document.body.classList.add('light-theme');
    toggle.checked = true;
  }
  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.body.classList.add('light-theme');
      localStorage.setItem('theme', 'light');
    } else {
      document.body.classList.remove('light-theme');
      localStorage.setItem('theme', 'dark');
    }
  });

  // Кнопка прокрутки догори
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  if (scrollTopBtn) {
    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        scrollTopBtn.classList.add('show');
      } else {
        scrollTopBtn.classList.remove('show');
      }
    });
  }

  // Обробники кнопок навігації
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');
      switchTab(tab, btn);
    });
  });

  // Обробники жанрів
  document.querySelectorAll('.genre-btn').forEach(button => {
    button.addEventListener('click', () => {
      const genre = button.getAttribute('data-genre');
      filterByGenre(genre);
    });
  });

// Обробник пошуку
// Обробник пошуку
document.getElementById('searchInput').addEventListener('input', () => {
  const val = document.getElementById('searchInput').value.trim().toLowerCase();
  const container = document.getElementById('searchResults');
  container.innerHTML = '';
  if (!val) return;

  // 1. Знайшли всі збіги
  const results = films.filter(f =>
    unmaskWord(f['Назва'] || '').toLowerCase().includes(unmaskWord(val))
  );

  // ...після const results = films.filter(...)

const uniqueResults = [];
const seenTitles = new Set();
for (const f of results) {
  if (!seenTitles.has(f['Назва'])) {
    uniqueResults.push(f);
    seenTitles.add(f['Назва']);
  }
}

  // 2. Лівому лишаємо тільки одну копію кожної назви
  const matchedSeries = results.filter(f => f['Тип']?.trim().toLowerCase() === 'серіал');
if (matchedSeries.length) {
  const grouped = matchedSeries.reduce((acc, ep) => {
    const title = ep['Назва'];
    if (!acc[title]) acc[title] = [];
    const key = (ep['Опис']||'').trim().toLowerCase();
    if (!acc[title].some(e => (e['Опис']||'').trim().toLowerCase() === key)) {
      acc[title].push(ep);
    }
    return acc;
  }, {});

  container.innerHTML = Object.entries(grouped).map(([title, episodes]) => {
    const safe = safeId(title);
    const count = episodes.length;
    const isPro = localStorage.getItem('isProUser') === 'true';
    const isProSeries = episodes[0]['Доступ'] === 'PRO';
    const poster = (isProSeries && !isPro)
      ? placeholderImage
      : (episodes[0]['Фото'] || placeholderImage);

    return `
      <div class="film-card" id="film-${safe}">
        <img src="${poster}" class="film-img" alt="${title}">
        <h3>${maskWord(title)}</h3>
        <p class="film-imdb">IMDb: ${episodes[0]['IMDb'] || '—'}</p>
        <button class="search-button" onclick="toggleEpisodes('${safe}', this)" data-count="${count}">
          📺 Показати серії (${count})
        </button>
        <div id="episodes-${safe}" class="series-episodes-grid" style="display:none;" data-count="${count}">
          ${episodes.map((ep, i) => {
            const label = ep['Опис'] || `Серія ${i+1}`;
            return ep.message_id
              ? `<button class="search-button" onclick="requestFilmByName('${ep.message_id}')">${label}</button>`
              : `<button class="search-button" onclick="openVideoById('${title}')">${label}</button>`;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');
  return;
}


  // === Якщо серед унікальних результатів є серіали — групуємо їх ===
  const seriesResults = uniqueResults.filter(f => f['Тип']?.trim().toLowerCase() === 'серіал');
  if (seriesResults.length) {
    const grouped = seriesResults.reduce((acc, ep) => {
      const title = ep['Назва'];
      if (!acc[title]) acc[title] = [];
      const uniqueKey = (ep['Опис'] || '').toLowerCase();
      if (!acc[title].some(e => (e['Опис'] || '').toLowerCase() === uniqueKey)) {
        acc[title].push(ep);
      }
      return acc;
    }, {});

    container.innerHTML = Object.entries(grouped).map(([title, episodes]) => {
      const safe = safeId(title);
      const count = episodes.length;
      const isPro = localStorage.getItem('isProUser') === 'true';
      const isProSeries = episodes[0]['Доступ'] === 'PRO';
      const poster = (isProSeries && !isPro)
        ? placeholderImage
        : (episodes[0]['Фото'] || placeholderImage);

      return `
        <div class="film-card" id="film-${safe}">
          <img src="${poster}" class="film-img" alt="${title}">
          <h3>${maskWord(title)}</h3>
          <p class="film-imdb">IMDb: ${episodes[0]['IMDb'] || '—'}</p>
          <button class="search-button" onclick="toggleEpisodes('${safe}', this)" data-count="${count}">
            📺 Показати серії (${count})
          </button>
          <div id="episodes-${safe}" class="series-episodes-grid" style="display:none;" data-count="${count}">
            ${episodes.map((ep, i) => {
              const label = ep['Опис'] || `Серія ${i+1}`;
              return ep.message_id
                ? `<button class="search-button" onclick="requestFilmByName('${ep.message_id}')">${label}</button>`
                : `<button class="search-button" onclick="openVideoById('${title}')">${label}</button>`;
            }).join('')}
          </div>
        </div>
      `;
    }).join('');
    return;
  }

  // === Якщо нічого не знайдено ===
  if (uniqueResults.length === 0) {
    container.innerHTML = `
      <p>Фільм не знайдено 😢</p>
      <button class="suggest-button" onclick="suggestFilm()">➕ Замовити цей фільм</button>
    `;
    return;
  }

  // === Інакше — звичайний рендер унікальних фільмів ===
  container.innerHTML = uniqueResults.map(f => {
    const id = safeId(f['Назва']);
    const isPro = localStorage.getItem('isProUser') === 'true';
    const locked = f['Доступ'] === 'PRO' && !isPro;
    const img = locked ? placeholderImage : (f['Фото'] || placeholderImage);
    const watchBtn = locked
      ? `<button class="search-button" onclick="showProModal()">🔒 PRO</button>`
      : `<button class="search-button" onclick="openVideoById('${f['Назва']}')">▶️ Дивитись</button>`;

    return `
      <div class="film-card" id="film-${id}">
        <img src="${img}" alt="${f['Назва']}" class="film-img">
        <h3>${maskWord(f['Назва'])}</h3>
        <p class="film-imdb">IMDb: ${f['IMDb'] || '—'}</p>
        <p>${f['Опис'] || ''}</p>
        <div class="film-actions">
          ${renderControls(f['Назва'], f['Опис'])}
          ${watchBtn}
        </div>
      </div>
    `;
  }).join('');
});





  // Клік по картці
  document.addEventListener('click', (e) => {
    const card = e.target.closest('.film-card');
    if (card && !e.target.closest('button')) {
      card.classList.toggle('expanded');
    }
  });

});



function addToFavorites(title, description, message_id) {
  // Знайти реальний message_id у масиві films
  const film = films.find(f => unmaskWord(f['Назва']) === unmaskWord(title));
  const real_message_id = film?.message_id || message_id || '';

  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
  if (favs.find(f => f.title === title)) {
    showServiceErrorModal('Вже в улюбленому 💛');
    return;
  }
  favs.push({ title, description, message_id: real_message_id });
  localStorage.setItem('favorites', JSON.stringify(favs));
  showFavorites();
  alert('Додано в улюблене!');
}




     let isSending = false;
async function requestWithRetry(url, options, retries = 3, delay = 1000) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(url, options);
      if (res.ok) return res;
    } catch (e) {
      console.warn(`⚠️ Спроба ${i + 1} не вдалася`);
    }
    await new Promise(resolve => setTimeout(resolve, delay));
  }
  throw new Error("❌ Усі спроби запиту не вдалися");
}


function rateFilm(filmName, action) {
  const key = `rating-${safeId(filmName)}`;
  const previousAction = localStorage.getItem(key);

  // Якщо користувач натиснув ту ж саму кнопку — нічого не робимо
  if (previousAction === action) return;
  localStorage.setItem(key, action);

  // Відправляємо оновлення на бекенд
  fetch('https://relax-time2.onrender.com/rate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      film_name: filmName,
      action: action,
      undo: previousAction
    }),
  });

  // Знаходимо елементи-лічильники
  const likeBtnCount    = document.getElementById(`like-count-btn-${safeId(filmName)}`);
  const dislikeBtnCount = document.getElementById(`dislike-count-btn-${safeId(filmName)}`);
  const likeDisplay     = document.getElementById(`like-count-${safeId(filmName)}`);
  const dislikeDisplay  = document.getElementById(`dislike-count-${safeId(filmName)}`);

  // Функція для безпечного оновлення числа
  function upd(el, delta) {
    if (!el) return;
    el.textContent = Math.max(0, Number(el.textContent || 0) + delta);
  }

  // Інкремент/декремент відповідно до дії
  if (action === 'like') {
    upd(likeBtnCount,    +1);
    upd(likeDisplay,     +1);
    if (previousAction === 'dislike') {
      upd(dislikeBtnCount, -1);
      upd(dislikeDisplay,  -1);
    }
  } else {
    upd(dislikeBtnCount, +1);
    upd(dislikeDisplay,  +1);
    if (previousAction === 'like') {
      upd(likeBtnCount,   -1);
      upd(likeDisplay,    -1);
    }
  }

  // Підсвічуємо активну кнопку
  const card       = likeBtnCount.closest('.film-card');
  const likeBtn    = card.querySelector('.rating-button:nth-of-type(1)');
  const dislikeBtn = card.querySelector('.rating-button:nth-of-type(2)');
  likeBtn.classList.remove('active-like');
  dislikeBtn.classList.remove('active-dislike');
  if (action === 'like')    likeBtn.classList.add('active-like');
  if (action === 'dislike') dislikeBtn.classList.add('active-dislike');
}



async function suggestFilm() {
  const val = document.getElementById('searchInput').value.trim();
  if (!val || isSending) return;

  const tg = window.Telegram.WebApp;
  if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
    alert("⛔️ Не вдалося отримати ваш Telegram ID. Оновіть застосунок!");
    window.location.reload();
    return;
  }
  const user = tg.initDataUnsafe.user;
  

  isSending = true;

  const btn = document.querySelector(".suggest-button");
  if (btn) {
    btn.disabled = true;
    setTimeout(() => btn.disabled = false, 7000);
  }

  document.getElementById('request-loading').style.display = 'flex'; // ⏳ Показати

  try {
    await fetch('https://relax-time2.onrender.com/ping');
    await new Promise(resolve => setTimeout(resolve, 1000));

    const res = await requestWithRetry('https://relax-time2.onrender.com/request-film', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id, film_name: val })
    });

    const contentType = res.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
      const data = await res.json();
      showSuggestResult({
        success: data.ok !== false,
        remaining_requests: data.remaining_requests || '∞',
        is_pro: data.is_pro
      });
    } else {
      showSuggestResult({
        success: false,
        is_pro: false,
        remaining_requests: 0
      });
    }

  } catch (error) {
    console.error(error);
    showSuggestResult({
      success: false,
      is_pro: false,
      remaining_requests: 0
    });
  } finally {
    isSending = false;
    document.getElementById('request-loading').style.display = 'none'; // ⛔ Сховати
  }
}

  

    function toggleHistory() {
  const container = document.getElementById('history-list');
  if (container.style.display === 'block') {
    container.style.display = 'none';
  } else {
    showHistory();
  }
}



// ✅ ВИНЕСИ окремо функцію rate() після showHistory
function rate(title, stars) {
  localStorage.setItem(`rating_${title}`, stars);
  showHistory();
}


function clearHistory() {
  localStorage.removeItem('history');
  showHistory(); // одразу оновлює вивід
}
      
 

   function goToCartoons() {
  switchTab('categories', document.querySelector('[data-tab=categories]'));
  openGenreGroup('cartoons');

  // Додаємо плавну прокрутку через 300 мс, коли все відкриється
  setTimeout(() => {
    const target = document.getElementById('group-cartoons');
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 300);
}

function closeDonatePopup() {
  const popup = document.getElementById('donate-popup');
  if (popup) {
    popup.style.opacity = '0';
    setTimeout(() => {
      popup.style.display = 'none';
    }, 300);
  }
}
// ✅ Автоматичне стабільне віконце донату через 20 секунд
setTimeout(() => {
  const popup = document.getElementById('donate-popup');
  if (popup) {
    popup.style.display = 'block';
    popup.style.opacity = '0';
    popup.style.transition = 'opacity 0.5s ease';
    setTimeout(() => popup.style.opacity = '1', 10);
  }
}, 20000);

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function goToSeries(seriesTitle) {
  switchTab('categories', document.querySelector('[data-tab=categories]'));
  openGenreGroup('series');

  setTimeout(() => {
    const filtered = films.filter(f => f['Назва'] === seriesTitle && f['Тип'] === 'Серіал');

    if (filtered.length === 0) {
      alert('Серіал не знайдено 😢');
      return;
    }

    const container = document.getElementById('genre-results');
    const grouped = { [seriesTitle]: filtered };

container.innerHTML = Object.entries(grouped).map(([title, episodes]) => {
  const first = episodes[0];
  const isPro = localStorage.getItem('isProUser') === 'true';
  const isProFilm = first['Доступ'] === 'PRO';
  const imgSrc = (isProFilm && !isPro) ? placeholderImage : first['Фото'];
  const imdb = first['IMDb'] || "—";
  const desc = first['Опис'] || '';
  const likes = Number(first['Лайки']) || 0;
  const dislikes = Number(first['Дизлайки']) || 0;
  const safe = safeId(title);

return `
  <div class="film-card" id="film-${id}">
    <img src="${imgSrc}" alt="${title}">
    <h3>${maskWord(title)}</h3>
    <p class="film-imdb">IMDb: ${first['IMDb'] || '—'}</p>
    <p class="film-desc">${desc}</p>

    ${renderControls(title, desc)}

    <div class="film-actions">
      ${isProFilm && !isPro 
        ? `<button class="search-button" onclick="showProModal()">🔒 PRO Доступ</button>`
        : episodes.map((ep, i) => {
            return `<button class="search-button" onclick="sendFilm('${ep['message_id']}')">${ep['Опис'] || 'Серія ' + (i + 1)}</button>`;
          }).join('')}
    </div>
  </div>
`;

}).join('');


    container.scrollIntoView({ behavior: 'smooth' });
  }, 300);
}

document.getElementById('getProBtn').addEventListener('click', () => {
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user;
    if (!user) {
        alert("❗️ Не вдалося отримати ваш Telegram ID");
        return;
    }

    const paymentInfo = "💳 PRO доступ — будь-яка сума, щоб бот залишався для своїх 😉";
    const paymentLink = "https://send.monobank.ua/jar/2FdmSYjoGo";

    alert(paymentInfo);
    window.open(paymentLink, "_blank");
  
    localStorage.setItem("paymentPending", "true");
    showConfirmPaidButton(user); // тут показуємо кнопку
    startProPolling();
});



function showConfirmPaidButton(user) {
  const btn = document.getElementById("confirmPaidBtn");
  btn.style.display = "block";
  closeDonatePopup();

  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);

  newBtn.onclick = () => {
    // 1) позначаємо, що юзер натиснув “Я оплатив”
    localStorage.setItem("paymentPending", "true");
    // 2) відправляємо запит підтвердження
    notifyPayment(user.id, user.username || "", user.first_name || "");
    // 3) ховаємо кнопку до відповіді
    newBtn.style.display = "none";
  };
}




let isPaymentSending = false;

async function notifyPayment(userId, username, firstName) {
  // Показуємо loader
  document.getElementById("payment-loading").style.display = "flex";
  try {
    const res = await fetch('https://relax-time2.onrender.com/notify-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: userId,
        username: username,
        first_name: firstName
      })
    });
    const data = await res.json();

    if (data.ok) {
      localStorage.removeItem("paymentPending");
      document.getElementById("confirmPaidBtn").style.display = "none";
      showPaymentResult(true);
    } else {
      showPaymentResult(false);
      document.getElementById("confirmPaidBtn").style.display = "block";
    }
  } catch (e) {
    console.error(e);
    showPaymentResult(false);
    document.getElementById("confirmPaidBtn").style.display = "block";
  } finally {
    // Ховаємо loader у будь-якому випадку
    document.getElementById("payment-loading").style.display = "none";
  }
}



function showPaymentResult(success) {
  if (success) {
    localStorage.removeItem('paymentPending');
    alert('✅ Оплату отримано. Чекайте підтвердження PRO-доступу.');
  } else {
    alert(
      '❌ Сталася помилка при підтвердженні оплати.\n\n' +
      '🔄 Зачекайте 10-15 сек і натисніть "Я оплатив" ще раз.\n' +
      'Якщо все одно не працює — напишіть адміну в бот.'
    );
  }
}




function showProPrompt() {
  const overlay = document.getElementById('video-overlay');
  const wrapper = document.getElementById('video-wrapper');

  wrapper.innerHTML = `
    <h3 style="color:#00f7ff;">🔒 Фільм доступний лише для PRO</h3>
    <p style="margin:15px 0;">Активуй PRO, щоб дивитись усі фільми без обмежень.</p>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="watch-btn" onclick="goToPro()">🚀 Перейти до PRO</button>
      <button class="watch-btn" onclick="closeVideo()">❌ Закрити</button>
    </div>
  `;

  overlay.style.display = 'flex';
  setTimeout(() => overlay.style.opacity = '1', 50);
}

function goToPro() {
  const overlay = document.getElementById('video-overlay');
  const wrapper = document.getElementById('video-wrapper');

  wrapper.innerHTML = '';
  overlay.style.opacity = '0';

  setTimeout(() => {
    overlay.style.display = 'none';
    switchTab('account', document.querySelector('[data-tab=account]'));

    // Одразу імітуємо натискання кнопки "Отримати PRO"
    const getProBtn = document.getElementById('getProBtn');
    if (getProBtn) getProBtn.click();
  }, 300);
}

    
function sendFilm(film_id) {
    if (!isDataLoaded) {
        alert("⏳ Дані ще завантажуються, зачекайте...");
        return;
    }

    const film = films.find(f => f.message_id === film_id);
    if (!film) {
        alert("❌ Фільм не знайдено, спробуйте пізніше.");
        return;
    }

    fetch('https://relax-time2.onrender.com/send-film-id', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            user_id: window.Telegram.WebApp.initDataUnsafe?.user?.id,
             message_id: film_id
        })
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            console.log("✅ Фільм відправлено");
        } else {
            alert("❌ Сталася помилка, спробуйте ще раз.");
        }
    })
    .catch(err => {
        console.error(err);
        showServiceErrorModal("⚠️ Помилка мережі, спробуйте ще раз через хвилину.");
    });
}


function toggleEpisodes(id, btn) {
  const grid = document.getElementById(`episodes-${id}`);
  const isHidden = getComputedStyle(grid).display === 'none';

  grid.style.display = isHidden ? 'grid' : 'none';
  btn.textContent = isHidden
    ? `🔽 Сховати серії`
    : `📺 Показати серії (${grid.dataset.count})`;
}

// Запуск регулярної перевірки PRO-статусу
function startProPolling() {
  if (proPollInterval) return;
  proPollInterval = setInterval(async () => {
    try {
      const res = await fetch('https://relax-time2.onrender.com/check-pro', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ user_id: window.Telegram.WebApp.initDataUnsafe.user.id })
      });
      const data = await res.json();
      if (data.isPro) {
        clearInterval(proPollInterval);
        proPollInterval = null;
        localStorage.removeItem("paymentPending");
        localStorage.setItem("isProUser", "true");
        updateUIAfterPro(data.expire_date);
      }
    } catch (e) { console.warn(e); }
  }, 5000); // кожні 5 секунд
}

// Оновити інтерфейс після підтвердження оплати
function updateUIAfterPro(expireDate) {
  const btn = document.getElementById("confirmPaidBtn");
  if (btn) btn.style.display = "none";
  const notice = document.createElement("p");
  notice.textContent = `✅ Ваш PRO активний до ${expireDate}`;
  notice.style.color = "#00f7ff";
  document.getElementById("getProBtn").after(notice);
}
// Додай цю функцію в кінець свого основного <script> блоку (або туди, де інші функції)
async function checkProPendingStatus() {
  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;
  if (!user) return;

  // 1. Перевіряємо статус PRO
  try {
    const proRes = await fetch('https://relax-time2.onrender.com/check-pro', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id })
    });
    const proData = await proRes.json();

    if (proData.isPro) {
      localStorage.setItem('isProUser', 'true');
      localStorage.removeItem('paymentPending');
      document.getElementById("confirmPaidBtn").style.display = "none";
      // Показати повідомлення, якщо хочеш
    } else {
      localStorage.removeItem('isProUser');
      // Якщо paymentPending == true, показуємо кнопку "Я оплатив"
      if (localStorage.getItem('paymentPending') === 'true') {
        showConfirmPaidButton(user);
        startProPolling();
      } else {
        document.getElementById("confirmPaidBtn").style.display = "none";
      }
    }
  } catch (e) {
    // Якщо була помилка — залишаємо кнопку для повтору!
    if (localStorage.getItem('paymentPending') === 'true') {
      showConfirmPaidButton(user);
    }
    console.warn('Проблема з перевіркою PRO:', e);
  }
}

// Якщо користувач повернувся у WebApp, але даних нема — оновити сторінку
document.addEventListener("visibilitychange", function() {
  if (!document.hidden && !window.Telegram.WebApp.initDataUnsafe?.user) {
    window.location.reload();
  }
});

function showRetryOverlay() {
  const overlay = document.getElementById('error-overlay');
  overlay.style.display = 'block';
  // коли користувач натисне «Перезавантажити» — оновити сторінку
  document.getElementById('reload-btn').onclick = () => {
    window.location.reload();
  };
}

document.getElementById('contact-admin-btn').onclick = function() {
  document.getElementById('admin-message-modal').style.display = 'block';
};

document.getElementById('close-admin-modal-btn').onclick = function() {
  document.getElementById('admin-message-modal').style.display = 'none';
};

document.getElementById('send-admin-message-btn').onclick = async function() {
  const text = document.getElementById('admin-message-text').value.trim();
  if (!text) {
    alert("Напишіть повідомлення!");
    return;
  }

  const tg = window.Telegram?.WebApp;
  const user_id = tg?.initDataUnsafe?.user?.id;

  if (!user_id) {
    alert("Не вдалося отримати ID користувача.");
    return;
  }

  // Відправляємо на бекенд
  try {
    const resp = await fetch('https://relax-time2.onrender.com/contact-admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id, text })
    });
    const res = await resp.json();
    if (res.ok) {
      alert('Повідомлення надіслано адміну!');
      document.getElementById('admin-message-modal').style.display = 'none';
      document.getElementById('admin-message-text').value = '';
    } else {
      alert('Сталася помилка. Спробуйте ще раз.');
    }
  } catch(e) {
    alert('Помилка мережі. Спробуйте ще раз.');
  }
};

</script>

<button id="scrollTopBtn" class="scroll-top-btn">🔝</button>

<div id="video-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; justify-content:center; align-items:center; transition: opacity 0.4s ease;">
  <div id="video-wrapper" style="background:#000; padding:20px; border-radius:12px; max-width:800px; width:90%; text-align:center; box-shadow: 0 0 20px rgba(0, 247, 255, 0.3);">
    <!-- Тут JS вставлятиме або loader, або відео через innerHTML -->
  </div>
</div>

<div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#1a1a1a; padding:20px; border-radius:12px; max-width:300px; text-align:center; box-shadow:0 0 20px #00f7ff;">
    <p style="color:#00f7ff; font-size:18px; margin-bottom:20px;">🎬 Бажаєте відкрити фільм?</p>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button onclick="confirmOpen()" style="padding:8px 16px; background:#00f7ff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Так</button>
      <button onclick="cancelOpen()" style="padding:8px 16px; background:#444; border:none; border-radius:8px; cursor:pointer; color:#fff;">Ні</button>
    </div>
  </div>
</div>

<div id="donate-popup" style="display:none; position:fixed; bottom:120px; left:50%; transform:translateX(-50%); z-index:9999;">

  
  <button onclick="closeDonatePopup()" style="
    position:absolute; top:6px; right:10px; background:none; 
    border:none; color:#fff; font-size:20px; cursor:pointer;">✖️</button>

  <p style="margin-bottom:10px; font-size:16px;">
    <span style="color:#00f7ff;">Твій донат</span> = 
    <span style="color:#ffcc00;">наша мотивація</span> працювати ще краще 💪
  </p>

  <a href="https://send.monobank.ua/jar/9wTjSL3xu2" target="_blank" style="
    padding:12px 24px; background:#00f7ff; color:#000; font-weight:bold;
    text-decoration:none; border-radius:10px; display:inline-block;
    box-shadow:0 0 15px #00f7ff; font-size:16px;
  ">☕ Підтримати RelaxTime</a>
</div>




<footer style="text-align:center; font-size:12px; color:#666; padding:15px 10px; line-height:1.4;">
  ⚠️ Весь контент лише для ознайомлення. Якщо ми порушили ваші авторські права — звертайтесь: 
  <a href="mailto:relax-time-bot@ukr.net" style="color:#00f7ff; text-decoration:underline;">relax-time-bot@ukr.net</a><br>
  ⚠️ All content is for informational purposes only. If we violated your copyright, contact us.
</footer>

<div id="pro-modal" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  
  <div style="background:#1a1a1a; padding:20px; border-radius:12px; max-width:300px; text-align:center; box-shadow:0 0 20px #00f7ff;">
    <p style="color:#00f7ff; font-size:18px; margin-bottom:20px;">🔒 Фільм доступний лише для PRO</p>
    <p style="margin-bottom:20px; color:#ccc;">Оформіть PRO, щоб дивитись усі фільми без обмежень.</p>
     <p style="margin-bottom:16px; color:#888; font-size:13px;">
    💸 Будь-яка сума — це вже PRO  
    <br>😉 Але чим більше — тим краще!
   </p>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button onclick="goToPro()" style="padding:8px 16px; background:#00f7ff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">🚀 Перейти до PRO</button>
      <button onclick="closeProModal()" style="padding:8px 16px; background:#444; border:none; border-radius:8px; cursor:pointer; color:#fff;">Закрити</button>
    </div>
  </div>
</div>
<script>
 
</script>
<!-- Модальне вікно -->
<div id="suggest-modal" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;
  opacity: 0; transition: opacity 0.3s ease;
">
  <div style="background:#222; padding:22px 20px; border-radius:12px; max-width:310px; text-align:center; box-shadow:0 0 15px #0ff;">
    <div id="suggest-modal-content" style="color:#fff; font-size:16px; line-height:1.5;"></div>
    <div style="margin-top:20px;">
      <button onclick="closeSuggestModal()" style="padding:8px 16px; background:#00f7ff; color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">ОК</button>
    </div>
  </div>
</div>


<script>
function showSuggestResult({ success, remaining_requests, is_pro }) {
  const modal = document.getElementById('suggest-modal');
  const content = document.getElementById('suggest-modal-content');

  if (success) {
    content.innerHTML = `
      ✅ Запит на фільм прийнято!<br><br>
      🆓 Залишилось: <b>${remaining_requests}</b> безкоштовних запитів.
    `;
  } else if (is_pro) {
    content.innerHTML = `
      ⚠️ Щось пішло не так при запиті, але у вас є PRO 😎<br><br>
      Повторіть спробу трохи пізніше.
    `;
  } else {
    content.innerHTML = `
      ⛔ Ви вичерпали ліміт запитів.<br><br>
      🔓 <b>Отримайте PRO</b> і замовляйте фільми без обмежень!
    `;
  }

  modal.style.display = 'flex';
  setTimeout(() => modal.style.opacity = '1', 10);
}



  function closeSuggestModal() {
    const modal = document.getElementById('suggest-modal');
    modal.style.opacity = '0';
    setTimeout(() => modal.style.display = 'none', 300);
  }


  async function requestFilm(filmName) {
    const telegramUser = window.Telegram.WebApp.initDataUnsafe?.user;
    if (!telegramUser) {
      alert("⛔ Не вдалося отримати дані користувача Telegram");
      return;
    }

    const userId = telegramUser.id;

    try {
      const res = await fetch("https://relax-time2.onrender.com/request-film", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, film_name: filmName })
      });

      const data = await res.json();

      showSuggestResult({
        success: res.ok,
        remaining_requests: data?.remaining_requests || 0,
        is_pro: data?.is_pro || false
      });

    } catch (error) {
      console.error("❗ Помилка запиту:", error);
      // 🔻 Тепер показує гарне модальне вікно, а не alert
      showSuggestResult({
        success: false,
        remaining_requests: 0,
        is_pro: false
      });
    }
  }

  function showServiceErrorModal(msg) {
  const modal = document.getElementById('service-error-modal');
  document.getElementById('service-error-message').innerHTML = msg || 'Сервіс тимчасово недоступний,<br>спробуйте ще раз через хвилину.';
  modal.style.display = 'flex';
  setTimeout(() => modal.style.opacity = '1', 10);
}

function closeServiceErrorModal() {
  const modal = document.getElementById('service-error-modal');
  modal.style.opacity = '0';
  setTimeout(() => modal.style.display = 'none', 300);
}

</script>


</div>

<div id="request-loading" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
  display: none;
  font-size: 18px;
  color: #00f7ff;
  text-align: center;
">
  <div style="
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
  ">
    <div class="loader"></div>
    <div style="margin-top:12px;">Надсилаємо запит...</div>
  </div>
</div>
<!-- Overlay для помилки перевірки підписки -->
<div id="error-overlay" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.85);
  color: #fff;
  font-family: sans-serif;
  text-align: center;
  padding-top: 40vh;
  z-index: 10000;
">
  <p style="font-size: 20px; margin-bottom: 20px;">❌ Помилка перевірки підписки</p>
  <button id="reload-btn" style="
    padding: 12px 24px;
    font-size: 18px;
    background: #00f7ff;
    color: #000;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 0 10px #00f7ff;
  ">
    🔄 Перезавантажити
  </button>
</div>
<!-- Модальне вікно помилки сервісу -->
<div id="service-error-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.85);
  z-index: 99999;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity 0.3s;
">
  <div style="
    background: #1a1a1a;
    padding: 28px 22px;
    border-radius: 14px;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 0 24px #00f7ff;
  ">
    <div style="font-size:32px; margin-bottom:15px;">😢</div>
    <div id="service-error-message" style="color:#00f7ff; font-size:17px; margin-bottom:22px;">
      Сервіс тимчасово недоступний,<br>спробуйте ще раз через хвилину.
    </div>
    <button onclick="closeServiceErrorModal()" style="
      padding: 8px 20px; background: #00f7ff; color: #000;
      border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
      font-size: 16px;
    ">OK</button>
  </div>
</div>

<script>
  // Відкрити чат з лаунчер-ботом із payload'ом (хто натиснув)
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('launcher-btn');
    if (!btn) return;

    btn.addEventListener('click', () => {
      const tg  = window.Telegram?.WebApp;
      const uid = tg?.initDataUnsafe?.user?.id || '';
      const url = `https://t.me/relax_time_launcher_bot?start=from_webapp_${uid}`;

      try {
        if (tg?.openTelegramLink) tg.openTelegramLink(url);
        else if (tg?.openLink)    tg.openLink(url);
        else                      window.open(url, '_blank');
        tg?.HapticFeedback?.impactOccurred('medium');
      } catch (_) {
        window.open(url, '_blank');
      }
    });
  });
</script>

  
</body>
</html>
